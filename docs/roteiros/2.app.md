# Computação em Nuvem

**Autor**: Tiago Demay

---

## Deployment Orchestration

### Utilizando a infraestrutura Bare Metal com o Juju

Vamos utilizar o Juju para deploy de **uma** das arquiteturas abaixo.

As aplicações que vamos utilizar são:

- [Grafana](https://grafana.com/) junto com o [Prometheus](https://prometheus.io/)

---

### Instale o Dashboard do JUJU para o controlador principal (controller)!!

[Dashboard-JUJU](https://charmhub.io/juju-dashboard)

Utilize a documentação do Link e instale o DashBoard do JUJU, acesse o Dashboard JUJU para ver os deploys das aplicações funcionando, nas tarefa será pedido um print da tela do DashBoard.

Volte para o controlador e modelo das aplicações, com os comandos:

```bash
juju models
```

```bash
juju switch maas-controller:admin/maas
```

---

### Faça o deploy da Aplicação Grafana e Prometheus

#### Deploy Grafana e Prometheus

O [Grafana](https://grafana.com/) é uma plataforma de código aberto que simplifica a apresentação visual de dados, como gráficos e painéis, facilitando a compreensão em tempo real de sistemas e informações.

Para funcionar, o Grafana requer um banco de dados para armazenar configurações, metadados e informações relacionadas à exibição de dados em seus painéis e gráficos. Ele é compatível com vários bancos de dados, como Prometheus, MySQL, PostgreSQL, InfluxDB, SQLite3 e outros. Neste contexto, estamos utilizando o **Prometheus** como banco de dados, mas você tem a flexibilidade de escolher outro se preferir.

- Crie uma pasta chamada **charms** para baixar o charm do Grafana e do Prometheus do repositório charm-hub.

  ```bash
  mkdir -p /home/cloud/charms
  cd /home/cloud/charms
  ```

- Baixe o charm do [Grafana](https://charmhub.io/grafana) usando o comando **juju download**.

  ```bash
  juju download grafana
  ```

- Também vamos utilizar o charm do [Prometheus](https://prometheus.io/)

  ```bash
  juju download prometheus2
  ```

#### Agora é só fazer o Deploy com o auxilio do **JUJU**

- Faça o deploy do charm **prometheus**, para fazer deploy do charm local, use 

  ```bash
  juju deploy ./prometheus2_XXX.charm
  ```

#### Deploy do charm **grafana**

Ao realizar o Deploy do Grafana, acompanhe o processo utilizando o comando:

```bash
watch -n 1 juju status
```

Assim que a máquina estiver com o estado **ativo** realize os comandos abaixo:

1. Acesse a máquina onde o Grafana foi instalado
```bash
juju ssh grafana/X
```

2. Crie o diretório para armazenar as chaves GPG
```bash
sudo mkdir -p /etc/apt/keyrings
```

3. Baixe e atualize a chave GPG do repositório Grafana
```bash
curl -fsSL https://apt.grafana.com/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/grafana.gpg
```

4. Configure o repositório do Grafana para utilizar a chave atualizada
```bash
echo "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main" | sudo tee /etc/apt/sources.list.d/grafana.list
```

5. Atualize os pacotes e instale o Grafana manualmente
```bash
sudo apt-get update
sudo apt-get install grafana
```

6. Retorne ao Juju e reexecute o hook que falhou (**Apenas se o install do grafana já tiver falhado**)

```bash
juju resolved grafana/0 --retry
```

#### Integrando Grafana com Prometheus

- Utilize a documentação encontrada no **README** do charm do grafana.

  [LINKdocs1](https://canonical-juju.readthedocs-hosted.com/en/latest/user/reference/relation/?_gl=1*83wv03*_ga*NDA4MDg1OTUuMTc0MDY2NTMxMg..*_ga_5LTL1CNEJM*MTc0MDY2NTMxMS4xLjEuMTc0MDY2NTM3Ny41NS4wLjA.)

  [Linkdoc2](https://canonical-juju.readthedocs-hosted.com/en/latest/user/howto/manage-relations/#manage-relations)

- Acesse o dashboard do Grafana do seu computador e verifique o funcionamento do sistema.(Utilize seus conhecimentos do roteiro 1, para fazer este acesso, lembre-se que você não está na rede do KIT)

- Verifique se a integração foi feita corretamente. Para isso crie um dashboard dentro do grafana e adicione uma visualização (deve aparecer o prometheus como source).

---

!!! question "Lab2. Tarefa 1"
    [Tarefa 1 - Prairielearn](https://us.prairielearn.com/pl/course_instance/183202/assessment/2553562)  
    **Faça agora para não perder o estado!**

---

### Limpeza de ambiente !!!

- Limpe o deploy do Juju usando o command: 

  ```bash
  juju destroy-controller main

  ```
